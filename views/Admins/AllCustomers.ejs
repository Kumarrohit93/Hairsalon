<% layout("/Boilerplates/Admin") %>
<%
function time(t){
  if(!t) return "--";
  return new Date(t).toLocaleString("en-IN",{hour:"2-digit",minute:"2-digit", day:"2-digit", month:"short"});
}
%>

<div class="max-w-7xl mx-auto">

  <!-- HEADER -->
  <div class="mb-6">
    <h1 class="text-2xl font-semibold text-[#4a3a2f]">All Customers</h1>
    <p class="text-sm text-[#8b7765]">Complete customer history & live records</p>
  </div>

  <!-- STATS -->
  <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-8">

    <div class="p-4 rounded-2xl bg-white/90 border border-[#eadfce] shadow">
      <p class="text-xs text-[#8b7765]">Total Customers</p>
      <p class="text-2xl font-bold text-[#4a3a2f]"><%= allCustomers.length %></p>
    </div>

    <div class="p-4 rounded-2xl bg-white/90 border border-[#eadfce] shadow">
      <p class="text-xs text-[#8b7765]">Waiting</p>
      <p class="text-2xl font-bold text-yellow-600">
        <%= allCustomers.filter(c => c.status === "waiting").length %>
      </p>
    </div>

    <div class="p-4 rounded-2xl bg-white/90 border border-[#eadfce] shadow">
      <p class="text-xs text-[#8b7765]">Serving</p>
      <p class="text-2xl font-bold text-blue-600">
        <%= allCustomers.filter(c => c.status === "serving").length %>
      </p>
    </div>

    <div class="p-4 rounded-2xl bg-white/90 border border-[#eadfce] shadow">
      <p class="text-xs text-[#8b7765]">Completed</p>
      <p class="text-2xl font-bold text-green-600">
        <%= allCustomers.filter(c => c.status === "completed").length %>
      </p>
    </div>

  </div>

  <!-- CUSTOMER LIST -->
  <div class="space-y-4">

    <% allCustomers.forEach(c => { %>

      <div class="p-4 sm:p-5 rounded-2xl bg-white/90 border border-[#eadfce] shadow">

        <!-- TOP ROW -->
        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2">

          <div>
            <p class="text-xl font-bold text-[#4a3a2f]">
              #<%= c.tokenNumber || "--" %> â€¢ <%= c.name %>
            </p>
            <p class="text-xs text-[#8b7765]">
              ðŸ“ž <%= c.phone %> â€¢ <%= c.type %> â€¢ <%= c.publicToken %> 
            </p>
          </div>

          <div class="flex gap-2 flex-wrap">
            <form action="/admin/customer/<%= c.publicToken %>/delete" method="get"<button class="px-6 py-1 rounded-full text-md border border-gray-200 font-semibold">Delete Customer</button></a>
            <a href="/admin/customer/<%= c.publicToken %>/edit"><button class="px-6 py-1 rounded-full text-md border border-gray-200 font-semibold">Edit Payment Status</button></a>
            <span class="px-3 py-1 rounded-full text-xs font-semibold text-center
              <%= c.status === "waiting" ? "bg-yellow-100 text-yellow-700" :
                  c.status === "serving" ? "bg-blue-100 text-blue-700" :
                  c.status === "completed" ? "bg-green-100 text-green-700" :
                  "bg-red-100 text-red-700" %>">
              <%= c.status %>
            </span>

            <span class="px-3 py-1 rounded-full text-xs font-semibold
              <%= c.paymentStatus === "paid" ? "bg-green-100 text-green-700" :
                  c.paymentStatus === "pending" ? "bg-orange-100 text-orange-700" :
                  "bg-red-100 text-red-700" %>">
              payment: <%= c.paymentStatus %>
            </span>
          </div>

        </div>

        <!-- SERVICES -->
        <div class="mt-3 text-sm text-[#4a3a2f]">
          <span class="font-medium">Services:</span>
          <%= c.services && c.services.length ? c.services.map(s => s.name).join(", ") : "Walk-in" %>
        </div>

        <!-- DETAILS GRID -->
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mt-4 text-sm">

          <div>
            <p class="text-xs text-[#8b7765]">Total Time</p>
            <p class="font-semibold"><%= c.totalEstimatedTime || 0 %> min</p>
          </div>

          <div>
            <p class="text-xs text-[#8b7765]">Total Amount</p>
            <p class="font-semibold">â‚¹ <%= c.totalAmount || 0 %></p>
          </div>

          <div>
            <p class="text-xs text-[#8b7765]">Booked For</p>
            <p class="font-semibold">
  <%= c.services && c.services.length
        ? c.services.map(s => s.name).join(", ")
        : "Walk-in" %>
</p>
</p>
          </div>

          <div>
            <p class="text-xs text-[#8b7765]">Created</p>
            <p class="font-semibold"><%= time(c.createdAt) %></p>
          </div>

        </div>

        <!-- TIME LINE -->
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mt-4 text-xs text-[#6d5a4c]">

          <div>Check-in: <%= time(c.checkInTime) %></div>
          <div>Start: <%= time(c.serviceStartTime) %></div>
          <div>End: <%= time(c.serviceEndTime) %></div>
          <div>ETA End: <%= time(c.estimatedEndTime) %></div>

        </div>
<div class="mt-2">
  <p class="text-sm">Link for status: /status/<%= c.publicToken %></p>
</div>
      </div>

    <% }) %>

    <% if(allCustomers.length === 0){ %>
      <p class="text-sm text-[#8b7765]">No customers found.</p>
    <% } %>

  </div>

</div>
